<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions Biotope – Nation Formation</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:monospace}
#ui{
  position:absolute;bottom:10px;left:50%;
  transform:translateX(-50%);
  width:90%;text-align:center;color:#0f0
}
#stats{font-size:12px;margin-bottom:4px;color:#aaa}
#log{
  position:absolute;top:10px;left:10px;
  width:320px;height:200px;overflow:auto;
  font-size:11px;color:#0f0;
  background:rgba(0,0,0,.65);
  border:1px solid #022;padding:6px
}
.warning{color:#f00}
</style>
</head>

<body>
<div id="log"></div>

<div id="ui">
  <div id="stats">
    YEAR:<span id="year">0</span> |
    RED:<span id="rpop">0</span> |
    BLUE:<span id="bpop">0</span> |
    RED STATE:<span id="rstate">TRIBE</span> |
    BLUE STATE:<span id="bstate">TRIBE</span>
  </div>
</div>

<script>
/* ========= 世界 ========= */
let agents=[];
let territory=[];
let food=[];
let year=0, frame=0;

const GRID=22;
let cols, rows;

let redNation=false;
let blueNation=false;

/* ========= リーダー ========= */
const leaderRed={pos:null};
const leaderBlue={pos:null};

/* ========= 初期化 ========= */
function setup(){
  createCanvas(windowWidth,windowHeight);
  cols=floor(width/GRID);
  rows=floor(height/GRID);

  territory=new Array(cols*rows).fill(null);
  food=new Array(cols*rows).fill(0);

  // リーダー配置
  leaderRed.pos=createVector(width*0.25,height/2);
  leaderBlue.pos=createVector(width*0.75,height/2);

  // 初期エージェント
  for(let i=0;i<30;i++){
    agents.push(new Agent("red"));
    agents.push(new Agent("blue"));
  }

  spawnFood(300);
}

/* ========= ループ ========= */
function draw(){
  background(0,15,5);
  frame++; if(frame%60===0) year++;

  drawTerritory();
  updateFood();

  let r=0,b=0;

  for(let i=agents.length-1;i>=0;i--){
    let a=agents[i];
    a.update();
    a.show();
    if(a.dead()) agents.splice(i,1);
    else a.team==="red"?r++:b++;
  }

  // 国家形成判定
  let rLand=countLand("red");
  let bLand=countLand("blue");

  if(rLand>300) redNation=true;
  if(bLand>300) blueNation=true;

  yearEl.innerText=year;
  rpop.innerText=r;
  bpop.innerText=b;
  rstate.innerText=redNation?"NATION":"TRIBE";
  bstate.innerText=blueNation?"NATION":"TRIBE";
}

/* ========= エージェント ========= */
class Agent{
  constructor(team){
    this.team=team;
    this.pos=p5.Vector.random2D().mult(50)
      .add(team==="red"?leaderRed.pos:leaderBlue.pos);
    this.vel=p5.Vector.random2D();
    this.energy=50;
    this.speed=team==="blue"?1.6:1.2;
  }

  update(){
    // リーダーへの志向（国家で強化）
    let leader=this.team==="red"?leaderRed.pos:leaderBlue.pos;
    let pull=p5.Vector.sub(leader,this.pos)
      .setMag((this.team==="red"?0.15:0.12)*(this.isNation()?1.5:1));
    this.vel.add(pull);

    // ランダム性＝生物の自由
    this.vel.add(p5.Vector.random2D().mult(0.4));
    this.vel.limit(this.speed);
    this.pos.add(this.vel);

    this.wrap();

    let gx=floor(this.pos.x/GRID);
    let gy=floor(this.pos.y/GRID);
    let idx=gx+gy*cols;
    territory[idx]=this.team;

    if(food[idx]>0){
      this.energy+=this.isNation()?1.6:1;
      food[idx]-=1;
    }
    this.energy-=0.12;
  }

  isNation(){
    return this.team==="red"?redNation:blueNation;
  }

  dead(){return this.energy<=0;}

  wrap(){
    if(this.pos.x<0) this.pos.x=width;
    if(this.pos.x>width) this.pos.x=0;
    if(this.pos.y<0) this.pos.y=height;
    if(this.pos.y>height) this.pos.y=0;
  }

  show(){
    noStroke();
    fill(this.team==="red"?color(255,70,70):color(80,80,255));
    rect(this.pos.x-2,this.pos.y-2,4,4);
  }
}

/* ========= 描画 ========= */
function drawTerritory(){
  for(let i=0;i<territory.length;i++){
    if(!territory[i]) continue;
    let x=(i%cols)*GRID;
    let y=floor(i/cols)*GRID;
    fill(territory[i]==="red"
      ?"rgba(255,0,0,0.15)"
      :"rgba(0,0,255,0.15)");
    rect(x,y,GRID,GRID);
  }

  // リーダー描画（大きい）
  noStroke();
  fill(255,0,0);
  circle(leaderRed.pos.x,leaderRed.pos.y,18);
  fill(0,0,255);
  circle(leaderBlue.pos.x,leaderBlue.pos.y,18);
}

/* ========= 餌 ========= */
function updateFood(){
  for(let i=0;i<food.length;i++){
    if(territory[i]) food[i]+=0.01;
    food[i]=min(food[i],8);
  }
}
function spawnFood(n){
  for(let i=0;i<n;i++){
    food[floor(random(food.length))]+=1;
  }
}

/* ========= 補助 ========= */
function countLand(team){
  return territory.filter(t=>t===team).length;
}
function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
}
</script>
</body>
</html>
