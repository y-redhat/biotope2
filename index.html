<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions Biotope ‚Äì Ideological Civilization</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{
  margin:0;
  background:#000;
  overflow:hidden;
  font-family:monospace;
}
#ui{
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  text-align:center;
  z-index:10;
}
input{
  width:60%;
  padding:10px;
  background:rgba(0,0,0,.8);
  border:1px solid #0f0;
  color:#0f0;
}
#stats{
  color:#aaa;
  font-size:12px;
  margin-bottom:4px;
}
#log{
  position:absolute;
  top:10px;
  left:10px;
  width:320px;
  height:220px;
  overflow:auto;
  font-size:11px;
  color:#0f0;
  background:rgba(0,0,0,.65);
  border:1px solid #022;
  padding:6px;
}
.warning{color:#f00}
</style>
</head>

<body>
<div id="log"></div>

<div id="ui">
  <div id="stats">
    YEAR:<span id="year">0</span> |
    RED:<span id="rpop">0</span> |
    BLUE:<span id="bpop">0</span> |
    STATE:<span id="state">STABLE</span>
  </div>
  <input id="cmd" placeholder="> genesis / accelerate / purge / monopoly / reset">
</div>

<script>
/* =====================
   ‰∏ñÁïåË®≠ÂÆö
===================== */
let agents=[];
let foods=[];
let territory=[];
let year=0, frame=0;
let war=false;

const GRID=22;
let cols,rows;

const IDEOLOGY={
  RED:"collective",
  BLUE:"market"
};

/* =====================
   AIÊåáÂ∞éËÄÖÔºàÁ∞°ÊòìÂ≠¶ÁøíÔºâ
===================== */
class Leader{
  constructor(name){
    this.name=name;
    this.bias={expand:1, save:1, grow:1};
    this.lastScore=0;
  }
  adapt(score){
    let diff=score-this.lastScore;
    let k=random(["expand","save","grow"]);
    this.bias[k]+=diff*0.005;
    this.bias[k]=constrain(this.bias[k],0.5,2.5);
    this.lastScore=score;
  }
}

const leaderRed=new Leader("RED_CORE");
const leaderBlue=new Leader("BLUE_CORE");

/* =====================
   ÂàùÊúüÂåñ
===================== */
function setup(){
  createCanvas(windowWidth,windowHeight);
  cols=floor(width/GRID);
  rows=floor(height/GRID);
  territory=new Array(cols*rows).fill(null);
  spawnFood(250);
  runCommand("genesis");

  const input=document.getElementById("cmd");
  input.focus();
  input.addEventListener("keydown",e=>{
    if(e.key==="Enter"){
      runCommand(input.value);
      input.value="";
    }
  });
}

/* =====================
   „É°„Ç§„É≥„É´„Éº„Éó
===================== */
function draw(){
  frame++;
  if(frame%60===0) year++;

  background(0,20,10);

  drawTerritory();
  updateFood();

  let r=0,b=0;

  for(let i=agents.length-1;i>=0;i--){
    let a=agents[i];
    a.update();
    a.show();
    if(a.dead()) agents.splice(i,1);
    else a.team===IDEOLOGY.RED?r++:b++;
  }

  leaderRed.adapt(r);
  leaderBlue.adapt(b);

  // Ëá™ÁÑ∂Â¢óÊÆñ
  if(random()<0.015*leaderRed.bias.grow) agents.push(new Agent(IDEOLOGY.RED));
  if(random()<0.015*leaderBlue.bias.grow) agents.push(new Agent(IDEOLOGY.BLUE));

  // Êà¶‰∫â
  if(agents.length>100 && !war){
    war=true;
    state.innerText="WAR MODE";
    state.className="warning";
    log("!! TOTAL WAR TRIGGERED");
  }

  // „Ç§„Éô„É≥„Éà
  if(war && frame%300===0){
    if(r>b) purge();
    if(b>r) monopoly();
  }

  if(r<=10||b<=10){
    noLoop();
    state.innerText=r>b?"RED STABILIZATION":"BLUE DOMINANCE";
  }

  yearEl.innerText=year;
  rpop.innerText=r;
  bpop.innerText=b;
}

/* =====================
   „Ç®„Éº„Ç∏„Çß„É≥„Éà
===================== */
class Agent{
  constructor(team){
    this.team=team;
    this.pos=createVector(random(width),random(height));
    this.vel=p5.Vector.random2D();
    this.energy=50;
    this.speed=team===IDEOLOGY.BLUE?1.8:1.2;
  }

  update(){
    let ang=random(TWO_PI);
    this.vel.add(p5.Vector.fromAngle(ang).mult(0.2));
    this.vel.limit(this.speed);
    this.pos.add(this.vel);
    this.wrap();

    let gx=floor(this.pos.x/GRID);
    let gy=floor(this.pos.y/GRID);
    let idx=gx+gy*cols;
    territory[idx]=this.team;

    // È§å
    if(foods[idx]>0){
      this.energy+=this.team===territory[idx]?1.4:0.6;
      foods[idx]-=1;
    }

    this.energy-=war?0.25:0.1;
  }

  dead(){return this.energy<=0;}

  wrap(){
    if(this.pos.x<0) this.pos.x=width;
    if(this.pos.x>width) this.pos.x=0;
    if(this.pos.y<0) this.pos.y=height;
    if(this.pos.y>height) this.pos.y=0;
  }

  show(){
    noStroke();
    fill(this.team===IDEOLOGY.RED?color(255,50,50):color(80,80,255));
    rect(this.pos.x-2,this.pos.y-2,4,4);
  }
}

/* =====================
   È†òÂúü„ÉªÈ§å
===================== */
function drawTerritory(){
  for(let i=0;i<territory.length;i++){
    if(!territory[i]) continue;
    let x=(i%cols)*GRID;
    let y=floor(i/cols)*GRID;
    fill(territory[i]===IDEOLOGY.RED?
      "rgba(255,0,0,0.15)":
      "rgba(0,0,255,0.15)");
    rect(x,y,GRID,GRID);
  }
}

function updateFood(){
  let rT=territory.filter(t=>t===IDEOLOGY.RED).length;
  let bT=territory.filter(t=>t===IDEOLOGY.BLUE).length;

  for(let i=0;i<foods.length;i++){
    if(territory[i]===IDEOLOGY.RED) foods[i]+=rT*0.00004;
    if(territory[i]===IDEOLOGY.BLUE) foods[i]+=bT*0.00004;
    foods[i]=min(foods[i],10);
  }
}

/* =====================
   „Ç§„Éô„É≥„Éà
===================== */
function purge(){
  let reds=agents.filter(a=>a.team===IDEOLOGY.RED);
  reds.sort((a,b)=>a.energy-b.energy);
  let cut=floor(reds.length*0.15);
  agents=agents.filter(a=>!reds.slice(0,cut).includes(a));
  log("‚ò† PURGE EXECUTED");
}

function monopoly(){
  agents.filter(a=>a.team===IDEOLOGY.BLUE&&a.energy>70)
    .forEach(a=>{a.speed+=0.3;a.energy+=5});
  log("üè¶ MONOPOLY ESTABLISHED");
}

/* =====================
   „Ç≥„Éû„É≥„Éâ
===================== */
function runCommand(cmd){
  cmd=cmd.trim();
  if(cmd==="genesis"){
    for(let i=0;i<20;i++){
      agents.push(new Agent(IDEOLOGY.RED));
      agents.push(new Agent(IDEOLOGY.BLUE));
    }
    log("GENESIS INITIALIZED");
  }
  if(cmd==="accelerate"){
    agents.forEach(a=>a.speed+=0.2);
    log("EVOLUTION ACCELERATION");
  }
  if(cmd==="reset"){
    agents=[];foods=[];territory.fill(null);
    war=false;year=0;
    spawnFood(250);
    state.innerText="STABLE";
    log("SYSTEM RESET");
  }
}

/* =====================
   Ë£úÂä©
===================== */
function spawnFood(n){
  foods=new Array(cols*rows).fill(0);
  for(let i=0;i<n;i++){
    foods[floor(random(foods.length))]+=1;
  }
}
function log(t){
  logDiv.innerHTML=t+"<br>"+logDiv.innerHTML;
}
function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
}
</script>
</body>
</html>
