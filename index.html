<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>NovaNotions Biotope – Nation Simulation</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<style>
body{margin:0;background:#000;overflow:hidden;font-family:monospace}
#ui{
  position:absolute;bottom:8px;left:50%;
  transform:translateX(-50%);
  color:#0f0;font-size:12px
}
</style>
</head>
<body>

<div id="ui">
YEAR:<span id="year">0</span> |
RED:<span id="rpop">0</span> |
BLUE:<span id="bpop">0</span>
</div>

<script>
/* ===== 基本 ===== */
let agents=[], territory=[], food=[];
let frame=0, year=0;
const GRID=24;
let cols, rows;
const BORDER_X=()=>width/2;

/* ===== 国家 ===== */
let redNation=false, blueNation=false;
const leaderRed={pos:null};
const leaderBlue={pos:null};

/* ===== 初期化 ===== */
function setup(){
  createCanvas(windowWidth,windowHeight);
  cols=floor(width/GRID);
  rows=floor(height/GRID);
  territory=new Array(cols*rows).fill(null);
  food=new Array(cols*rows).fill(0);

  leaderRed.pos=createVector(width*0.25,height/2);
  leaderBlue.pos=createVector(width*0.75,height/2);

  for(let i=0;i<40;i++){
    agents.push(new Agent("red"));
    agents.push(new Agent("blue"));
  }
  spawnFood(400);
}

/* ===== メイン ===== */
function draw(){
  frame++; if(frame%60===0) year++;
  background(0,20,8);

  drawTerritory();
  drawBorder();
  drawLeaders();

  let r=0,b=0;
  for(let i=agents.length-1;i>=0;i--){
    let a=agents[i];
    a.update();
    a.show();
    if(a.dead()) agents.splice(i,1);
    else a.team==="red"?r++:b++;
  }

  if(countLand("red")>350) redNation=true;
  if(countLand("blue")>350) blueNation=true;

  yearEl.innerText=year;
  rpop.innerText=r;
  bpop.innerText=b;
}

/* ===== エージェント ===== */
class Agent{
  constructor(team){
    this.team=team;
    this.pos=createVector(
      team==="red"?random(width/2):random(width/2,width),
      random(height)
    );
    this.vel=p5.Vector.random2D().mult(1);
    this.energy=50;
    this.speed=team==="blue"?2.2:1.8;
    this.phase=random(TWO_PI);
  }

  update(){
    this.phase+=0.1;

    // リーダー志向
    let leader=this.team==="red"?leaderRed.pos:leaderBlue.pos;
    let dir=p5.Vector.sub(leader,this.pos).setMag(0.08);
    this.vel.add(dir);

    // 自由意志（はっきり動く）
    this.vel.add(p5.Vector.random2D().mult(0.6));

    // 国境ペナルティ
    if(this.team==="red" && this.pos.x>BORDER_X()) this.vel.x-=1;
    if(this.team==="blue" && this.pos.x<BORDER_X()) this.vel.x+=1;

    this.vel.limit(this.speed);
    this.pos.add(this.vel);
    this.wrap();

    let gx=floor(this.pos.x/GRID);
    let gy=floor(this.pos.y/GRID);
    let idx=gx+gy*cols;
    territory[idx]=this.team;

    if(food[idx]>0){
      this.energy+=this.isNation()?1.8:1.2;
      food[idx]-=1;
    }
    this.energy-=0.15;
  }

  isNation(){
    return this.team==="red"?redNation:blueNation;
  }

  dead(){return this.energy<=0;}

  wrap(){
    if(this.pos.y<0) this.pos.y=height;
    if(this.pos.y>height) this.pos.y=0;
    this.pos.x=constrain(this.pos.x,0,width);
  }

  show(){
    let pulse=sin(this.phase)*2;
    noStroke();
    fill(this.team==="red"?color(255,80,80):color(80,120,255));
    rect(this.pos.x-2,this.pos.y-2-pulse,4,4+pulse);
  }
}

/* ===== 描画 ===== */
function drawTerritory(){
  for(let i=0;i<territory.length;i++){
    if(!territory[i]) continue;
    let x=(i%cols)*GRID;
    let y=floor(i/cols)*GRID;
    fill(territory[i]==="red"
      ?"rgba(255,0,0,0.12)"
      :"rgba(0,0,255,0.12)");
    rect(x,y,GRID,GRID);
  }
}

function drawBorder(){
  stroke(0,255,0,120);
  for(let y=0;y<height;y+=20){
    if(frame%40<20) line(BORDER_X(),y,BORDER_X(),y+10);
  }
  noStroke();
}

function drawLeaders(){
  push();
  translate(leaderRed.pos.x,leaderRed.pos.y);
  rotate(frame*0.02);
  fill(255,0,0,180);
  rect(-10,-10,20,20);
  pop();

  push();
  translate(leaderBlue.pos.x,leaderBlue.pos.y);
  rotate(-frame*0.02);
  fill(0,0,255,180);
  rect(-10,-10,20,20);
  pop();
}

/* ===== 食料 ===== */
function spawnFood(n){
  for(let i=0;i<n;i++){
    food[floor(random(food.length))]+=1;
  }
}

/* ===== 補助 ===== */
function countLand(team){
  return territory.filter(t=>t===team).length;
}
function windowResized(){
  resizeCanvas(windowWidth,windowHeight);
}
</script>
</body>
</html>

