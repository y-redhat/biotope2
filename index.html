<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>IDEOLOGY BIOTOPE // LEADER CORE ONLINE</title>
<style>
html,body{margin:0;background:#000;color:#0f0;font-family:monospace;overflow:hidden}
#ui{position:fixed;top:0;left:0;width:100%;padding:6px;background:rgba(0,0,0,.85);border-bottom:1px solid #0f0}
canvas{display:block}
.warning{color:#f00;animation:flicker .12s infinite}
@keyframes flicker{50%{opacity:.4}}
</style>
</head>
<body>
<div id="ui">
<span id="status">SYSTEM STABLE</span> |
RED:<span id="rpop"></span> |
BLUE:<span id="bpop"></span>
</div>
<canvas id="c"></canvas>

<script>
const c=document.getElementById("c"),ctx=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;

const GRID=18,cols=Math.floor(c.width/GRID),rows=Math.floor(c.height/GRID);
let war=false,gameOver=false,frame=0;

const territory=Array(cols*rows).fill(null);
const food=Array(cols*rows).fill(0);

// ===== Leader (簡易学習ノード) =====
class Leader{
  constructor(team){
    this.team=team;
    this.w={grow:1,aggr:1,save:1};
    this.prevScore=0;
  }
  decide(){
    // ε-greedy
    if(Math.random()<0.1){
      return ["grow","aggr","save"][Math.floor(Math.random()*3)];
    }
    return Object.keys(this.w).reduce((a,b)=>this.w[a]>this.w[b]?a:b);
  }
  learn(score){
    const diff=score-this.prevScore;
    const act=this.decide();
    this.w[act]+=diff*0.01;
    this.w[act]=Math.max(0.2,Math.min(3,this.w[act]));
    this.prevScore=score;
  }
}

const leaderRed=new Leader("red");
const leaderBlue=new Leader("blue");

class Agent{
  constructor(team){
    this.team=team;
    this.x=Math.random()*c.width;
    this.y=Math.random()*c.height;
    this.energy=50;
    this.speed=team==="blue"?1.8:1.2;
  }
  step(leader){
    const aggr=leader.w.aggr;
    const ang=Math.random()*Math.PI*2;
    this.x+=Math.cos(ang)*this.speed*aggr*2;
    this.y+=Math.sin(ang)*this.speed*aggr*2;
    this.x=Math.max(0,Math.min(c.width,this.x));
    this.y=Math.max(0,Math.min(c.height,this.y));

    const gx=Math.floor(this.x/GRID),gy=Math.floor(this.y/GRID);
    const idx=gx+gy*cols;
    territory[idx]=this.team;

    // 食料摂取
    if(food[idx]>0){
      const gain=this.team===territory[idx]?1.5:0.6;
      this.energy+=gain;
      food[idx]-=1;
    }

    // 思想差
    this.energy+=this.team==="red"?0.04:Math.random()*0.08;
    this.energy-=war?0.25/leader.w.save:0.1;
  }
  draw(){
    ctx.fillStyle=this.team==="red"?"#f00":"#00f";
    ctx.fillRect(this.x-2,this.y-2,4,4);
  }
}

let agents=[];
for(let i=0;i<50;i++){agents.push(new Agent("red"),new Agent("blue"));}

// ===== Food & Territory =====
function updateFood(){
  // 領土数に応じて生成量UP
  let rT=0,bT=0;
  territory.forEach(t=>{if(t==="red")rT++; if(t==="blue")bT++;});
  for(let i=0;i<food.length;i++){
    if(territory[i]==="red") food[i]+=rT*0.00005;
    if(territory[i]==="blue") food[i]+=bT*0.00005;
    food[i]=Math.min(10,food[i]);
  }
}

function drawTerritory(){
  for(let i=0;i<territory.length;i++){
    const t=territory[i]; if(!t) continue;
    const x=(i%cols)*GRID,y=Math.floor(i/cols)*GRID;
    ctx.fillStyle=t==="red"?"rgba(255,0,0,.15)":"rgba(0,0,255,.15)";
    ctx.fillRect(x,y,GRID,GRID);
    if(food[i]>3){
      ctx.fillStyle="#0f0";
      ctx.fillRect(x+GRID/2-1,y+GRID/2-1,2,2);
    }
  }
}

// ===== Events =====
function purgeEvent(){
  // 共産主義：下位エネルギー削除
  const reds=agents.filter(a=>a.team==="red").sort((a,b)=>a.energy-b.energy);
  const cut=Math.min(5,Math.floor(reds.length*0.1));
  for(let i=0;i<cut;i++) agents.splice(agents.indexOf(reds[i]),1);
}
function monopolyEvent(){
  // 資本主義：上位強化
  agents.filter(a=>a.team==="blue"&&a.energy>70).forEach(a=>{
    a.speed+=0.2;
    a.energy+=5;
  });
}

// ===== Loop =====
function loop(){
  if(gameOver) return;
  frame++; ctx.clearRect(0,0,c.width,c.height);
  drawTerritory(); updateFood();

  let r=0,b=0;
  agents=agents.filter(a=>{
    const L=a.team==="red"?leaderRed:leaderBlue;
    a.step(L); a.draw();
    if(a.team==="red") r++; else b++;
    return a.energy>0;
  });

  // 学習スコア（人口+領土）
  leaderRed.learn(r);
  leaderBlue.learn(b);

  // 増殖（学習反映）
  if(Math.random()<0.02*leaderRed.w.grow) agents.push(new Agent("red"));
  if(Math.random()<0.02*leaderBlue.w.grow) agents.push(new Agent("blue"));

  if(agents.length>100&&!war){
    war=true;
    status.textContent="!!! WAR MODE / LEADER OVERRIDE !!!";
    status.className="warning";
  }

  if(war && frame%300===0){
    if(r>b) purgeEvent();
    if(b>r) monopolyEvent();
  }

  if(r<=10||b<=10){
    gameOver=true;
    status.textContent=r>b?"RED REGIME STABILIZED":"BLUE CORPORATE DOMINANCE";
  }

  rpop.textContent=r; bpop.textContent=b;
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
